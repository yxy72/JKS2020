C51 COMPILER V9.54   MAIN                                                                  11/27/2020 19:13:23 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\Program Files SSD\Keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(
                    -2)

line level    source

   1          /**********************************************************************
   2          
   3          交通科技大赛烧写程序_传感器_单片机_A6模块_云服务器_APP
   4          
   5          ***********************************************************************/
   6          
   7          #include "main.h"
   8          #include "HX711.h"
   9          #include "uart.h"
  10          #include "string.h"
  11          #include <stdio.h>
  12          typedef   unsigned char u8;
  13          typedef   unsigned int  u16;
  14          typedef   unsigned long u32;
  15          #define UART1_SendLR() UART1_SendData(0X0D)
  16          #define GapValue 22
  17          #define Buf_Max 70 
  18          unsigned long HX711_Buffer = 0;
  19          unsigned long Weight_Maopi = 0;
  20          long Weight_Shiwu = 0;
  21          xdata u8 Uart1_Buf[Buf_Max];
  22          unsigned char flag = 0;
  23          bit Flag_ERROR = 0;
  24          u8 First_Int = 0;
  25          u16 count_20ms;
  26          u8 TIME = 2;//2ms
  27          
  28          void Timer0Init(void){    //20毫秒@115200
  29   1        TMOD &= 0xF0;   
  30   1        TMOD |= 0x01;   //
  31   1        TL0 = (65536-20000)%256;    //
  32   1        TH0 = (65536-20000)/256;    //
  33   1        TF0 = 0;    //
  34   1        ET0 = 1;        //
  35   1        TR0 = 1;    //开始计时
  36   1      }
  37          void UART1_SendData(u8 dat){
  38   1        ES=0;     //关串口中断
  39   1        SBUF=dat;     
  40   1        while(TI!=1); //等待发送成功
  41   1        TI=0;     //清除发送中断标志
  42   1        ES=1;     //开串口中断
  43   1      }
  44          void CLR_Buf(void){
  45   1        u8 k;
  46   1        for(k=0;k<Buf_Max;k++)      //将缓存内容清零
  47   1        {
  48   2          Uart1_Buf[k] = 0x00;
  49   2        }
  50   1          First_Int = 0;              //接收字符串的起始存储位置
  51   1      }
  52          
  53          
  54          void delay_ms( ms){
C51 COMPILER V9.54   MAIN                                                                  11/27/2020 19:13:23 PAGE 2   

  55   1         count_20ms = ms;
  56   1         while(count_20ms);
  57   1      }
  58          
  59          void Timer0_ISR() interrupt 1{
  60   1        TR0=0;//关定时器
  61   1        TL0 = (65536-20000)%256;    //重设定时器初值
  62   1        TH0 = (65536-20000)/256;    //
  63   1        
  64   1        if(count_20ms > 0) //20ms延时计数器
  65   1        {
  66   2          count_20ms--;
  67   2        } 
  68   1        
  69   1        TR0=1;//开定时器
  70   1      }
  71          void UART1_ISR (void) interrupt 4{
  72   1        if (RI)
  73   1        {
  74   2          RI = 0;                           //清除RI位
  75   2          Uart1_Buf[First_Int] = SBUF;      //将接收到的字符串存到缓存中
  76   2          First_Int++;                    //缓存指针向后移动
  77   2          if(First_Int >= Buf_Max)          //如果缓存满,将缓存指针指向缓存的首地址
  78   2          {
  79   3            First_Int = 0;
  80   3          }   
  81   2        }
  82   1        if (TI)
  83   1        {
  84   2          TI = 0;                          //清除TI位
  85   2        }
  86   1      }
  87          void UART1_Send_Command(char *s){
  88   1        CLR_Buf(); 
  89   1        while(*s)//检测字符串结束符
  90   1        {
  91   2          UART1_SendData(*s++);//发送当前字符
  92   2        }
  93   1          UART1_SendLR();
  94   1      }
  95          
  96          u8 Find(){ 
  97   1      
  98   1        ES = 0;  //改进程序
  99   1        
 100   1        
 101   1        if( strstr(Uart1_Buf,"op")!=NULL) 
 102   1        {
 103   2          if( strstr(Uart1_Buf,"opmp")!=NULL) 
 104   2          {
 105   3            Get_Maopi();
 106   3          }
 107   2          else if(strstr(Uart1_Buf,"opt")!=NULL)//optX
 108   2          { 
 109   3            switch(Uart1_Buf[3]){
 110   4              case '2':TIME = 2; break;
 111   4              case '3':TIME = 3; break;
 112   4              case '5':TIME = 5; break;
 113   4              case 'a':TIME = 10; break;
 114   4              default: TIME = 2;
 115   4            } 
 116   3            
C51 COMPILER V9.54   MAIN                                                                  11/27/2020 19:13:23 PAGE 3   

 117   3          }
 118   2            
 119   2        }
 120   1      
 121   1        ES = 1;
 122   1        
 123   1      
 124   1        return 0;
 125   1        
 126   1          
 127   1      }
 128          
 129          
 130          
 131          
 132          
 133          u8 UART1_Correspond(u8 *b,u16 interval_time){
 134   1        CLR_Buf(); 
 135   1        UART1_Send_Command(b);
 136   1        delay_ms(interval_time);
 137   1        Find();
 138   1        return 0;
 139   1      }
 140          
 141          
 142          
 143          
 144          
 145          
 146          void Get_Weight(){
 147   1        Weight_Shiwu = HX711_Read();
 148   1        Weight_Shiwu = Weight_Shiwu - Weight_Maopi;   //获取净重
 149   1        if(Weight_Shiwu > 0)      
 150   1        { 
 151   2          Weight_Shiwu = (unsigned int)((float)Weight_Shiwu/GapValue);  //计算实物的实际重量
 152   2                                          
 153   2                                          
 154   2          if(Weight_Shiwu > 100000)   //超重报警
 155   2          {
 156   3            Flag_ERROR = 1; 
 157   3          }
 158   2          else
 159   2          {
 160   3            Flag_ERROR = 0;
 161   3          }
 162   2        }
 163   1        else
 164   1        {
 165   2          Weight_Shiwu = 0;
 166   2          Flag_ERROR = 1;       //负重报警
 167   2        }
 168   1        
 169   1      }
 170          
 171          void Get_Maopi(){
 172   1        Weight_Maopi = HX711_Read();  
 173   1      } 
 174          void Delay_ms1(unsigned int n){
 175   1        unsigned int  i,j;
 176   1        for(i=0;i<n;i++)
 177   1          for(j=0;j<123;j++);
 178   1      }
C51 COMPILER V9.54   MAIN                                                                  11/27/2020 19:13:23 PAGE 4   

 179          //****************************************************
 180          //主函数
 181          //****************************************************
 182          void main() 
 183          {
 184   1        char a[7];
 185   1           
 186   1        u8 i; 
 187   1        Timer0Init();
 188   1          Uart_Init();
 189   1        Get_Maopi();        //称毛皮重量
 190   1        EA = 1;      //开启总中断
 191   1        for(i = 0;i < 10;i++)//等待网络稳定
 192   1        {
 193   2          delay_ms(50);
 194   2        }
 195   1      
 196   1      
 197   1        a[0]='0';
 198   1        a[1]='3';
 199   1        a[2]=(0X30);
 200   1        a[3]=(0X30);
 201   1        a[5]=(0X30);
 202   1        a[6]=(0X30);
 203   1        a[4]='.';
 204   1        //a[5]='\n';  
 205   1      
 206   1        while(1)
 207   1        {
 208   2          EA = 0;
 209   2          Get_Weight();     
 210   2          EA = 1;
 211   2          if( Flag_ERROR == 1)
 212   2          {
 213   3                 UART1_Send_Command("0300.00");
 214   3          }   
 215   2          else
 216   2          {       
 217   3            a[2]=(Weight_Shiwu/10000 + 0X30);
 218   3                 a[3]=(Weight_Shiwu%10000/1000 + 0X30);
 219   3                 a[5]=(Weight_Shiwu%1000/100 + 0X30); 
 220   3                 a[6]=(Weight_Shiwu%100/10 + 0X30); 
 221   3            UART1_Correspond(a,50);
 222   3            Delay_ms1((TIME-1)*1000);
 223   3          }  
 224   2      
 225   2          
 226   2          
 227   2      
 228   2      
 229   2            
 230   2        } 
 231   1      }
 232          
 233          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    745    ----
   CONSTANT SIZE    =     20    ----
   XDATA SIZE       =     70    ----
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.54   MAIN                                                                  11/27/2020 19:13:23 PAGE 5   

   DATA SIZE        =     17      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
